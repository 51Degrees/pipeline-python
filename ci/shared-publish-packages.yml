# Template to install all the pre-requisites and to upload packages on specified feed.

parameters:
# publishEndpoint parameter takes the feed name, 
# where package is to be uploaded.
- name: publishEndpoint

steps:
# Authentication step for internal feed only.
- task: TwineAuthenticate@1
  displayName: 'Twine Authenticate '
  inputs:
    artifactFeed: 'pipeline-insider'
  condition: eq('${{ parameters.publishEndpoint }}', 'pipeline-insider')

# Authentication step for TestPyPI feed.
- task: TwineAuthenticate@1
  displayName: 'TestPyPI Twine Authenticate '
  inputs:
    pythonUploadServiceConnection: PyPITestAuthentication
  condition: eq('${{ parameters.publishEndpoint }}', 'testpypi')

# Authentication step for PyPI feed.
- task: TwineAuthenticate@1
  displayName: 'PyPI Twine Authenticate '
  inputs:
    pythonUploadServiceConnection: PyPIAuthentication
  condition: eq('${{ parameters.publishEndpoint }}', 'pypi')

# Specify Python Version used to install dependencies  
- task: UsePythonVersion@0
  displayName: 'Use Python $(pythonVersionDefault)'
  inputs:
    versionSpec: $(pythonVersionDefault)
    
- bash: |
     python -m pip install --upgrade pip
     pip install twine
  failOnStderr: true
  displayName: 'Install Twine'             

# Upload packages

- template: shared-upload-packages.yml
  parameters:
    publishEndpoint: ${{ parameters.publishEndpoint }}
    packageName: 'fiftyone_pipeline_core'

- template: shared-upload-packages.yml
  parameters:
    publishEndpoint: ${{ parameters.publishEndpoint }}
    packageName: 'fiftyone_pipeline_engines'

- template: shared-upload-packages.yml
  parameters:
    publishEndpoint: ${{ parameters.publishEndpoint }}
    packageName: 'fiftyone_pipeline_cloudrequestengine'         
    
- template: shared-upload-packages.yml
  parameters:
    publishEndpoint: ${{ parameters.publishEndpoint }}
    packageName: 'fiftyone_pipeline_engines_fiftyone'